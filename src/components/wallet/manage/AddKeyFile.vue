<template>
    <div class="add_key_file">
        <label>Keystore File</label>
        <form @submit.prevent="importKeyfile">
            <file-input @change="onfile" class="formIn" ref="fileIn"></file-input>
            <label>Password</label>
            <v-text-field class="formIn" placeholder="Password" dense
                        outlined color="#4C2E56" hide-details
                        type="password" v-model="pass"></v-text-field>
            <p v-if="err" class="err">{{err}}</p>
            <v-btn
                type="submit"
                :loading="isLoading"
                :disabled="!canSubmit"
                class="addKeyBut but_primary ava_button"
                depressed block
                color="#4C2E56"
            >Import Wallet</v-btn>
        </form>
    </div>
</template>
<script lang="ts">    
    import { Vue, Component, Ref } from 'vue-property-decorator';
    import FileInput from "@/components/misc/FileInput.vue";
    import {ImportKeyfileInput} from "@/store/types";
    import {KeyFile} from "@/js/IKeystore";

    @Component({
        components: {
            FileInput
        }
    })
    export default class AddKeyFile extends Vue {
        canAdd: boolean = false;
        pass: string = "";
        keyfile: File | null = null;
        isLoading: boolean = false;
        err: string | null = null;
        fileText: string|null = null;

        @Ref('fileIn') readonly fileIn!: FileInput


        get canSubmit(){
            return (this.keyfile && this.pass && this.fileText) ? true : false;
        }

        onfile(val: File) {
            this.keyfile = val;
            let parent = this;

            let reader = new FileReader();
                reader.addEventListener('load', async () => {
                    let res = reader.result as string;
                    parent.fileText = res;
                });
                reader.readAsText(val);
        }
        
        importKeyfile(){
            let fileData:KeyFile;
            try{
                fileData = JSON.parse(this.fileText as string);
            }catch(e){
                this.err = "Unable to parse JSON file."
                return;
            }


            this.isLoading = true;
            this.err = null;

            setTimeout(async () => {
                let input: ImportKeyfileInput = {
                    password: this.pass,
                    data: fileData
                }



                try {
                    await this.$store.dispatch("importKeyfile", input);
                    // @ts-ignore
                    this.$emit("success");
                    this.clear();
                } catch (err) {
                    this.isLoading = false;
                    if(err === "INVALID_PASS"){
                        this.err = "Invalid password."
                    }else{
                        this.err = "Failed to read keystore file."
                    }

                    // this.$store.dispatch("Notifications/add", {
                    //     type: "error",
                    //     title: "Import Failed",
                    //     message: err.message
                    // });
                }    
            }, 200);
        }

        clear() {
            this.isLoading = false;
            this.pass = "";
            this.keyfile = null;
            this.canAdd = false;
            this.err = null;
            this.fileIn.clear();
        }
    }
</script>
<style lang="scss">
    .add_key_file{
        fieldset{
            border: none !important;
        }
    }
</style>
<style scoped lang="scss">
@use '../../../main';

    .addKeyBut{
        color: #fff;
        text-transform: none;
        border-radius: 2px;
    }

    .v-btn{
        margin-top: 6px;
    }

    label{
        font-size: 12px;
        color: main.$primary-color-light;
    }

    .err{
        color: #f00;
        margin: 4px 0px;
        font-size: 12px;
    }

    .formIn{
        border: none;
        height: 40px;
        font-size: 12px;
        background-color: #F5F6FA;
        border-radius: 2px;
    }
</style>
